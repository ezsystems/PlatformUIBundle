<!doctype html>
<html>
<head>
<title>eZ Error view tests</title>
</head>
<body>

<div class="container"></div>

<script type="text/x-handlebars-template" id="errorview-ez-template">
    <div class="ez-error-content" tabindex="0">
        <h2>Oh oh, an error has occured</h2>
        <div class="additional-info">
            {{#if additionalInfo.errorCode}}
            Error code: {{ additionalInfo.errorCode }}<br/>
            {{/if}}
            {{#if additionalInfo.errorText}}
            Error text: {{ additionalInfo.errorText }}<br/>
            {{/if}}
        </div>
        <a href="#close-app" class="ez-close-app" data-icon="&#xe000;">Close the application</a>
        <a href="#retry" class="ez-retry" data-icon="&#xe00f;">Retry the operation</a>
    </div>
</script>

<script type="text/javascript" src="http://yui.yahooapis.com/3.12.0/build/yui/yui.js"></script>
<script>
    var filter = (window.location.search.match(/[?&]filter=([^&]+)/) || [])[1] || 'raw',
            loaderFilter;
    if (filter == 'coverage'){
        loaderFilter = {
            searchExp : "/Resources/",
            replaceStr: "/Tests/instrument/Resources/"
        };
    } else {
        loaderFilter = filter;
    }

    YUI({
        coverage: ['ez-errorview'],
        filter: loaderFilter,
        modules: {
            "ez-errorview": {
                requires: ['ez-templatebasedview', 'transition', 'event-tap'],
                fullpath: "../../../Resources/public/js/views/ez-errorview.js"
            },
            "ez-templatebasedview": {
                requires: ['view', 'handlebars'],
                fullpath: "../../../Resources/public/js/views/ez-templatebasedview.js"
            }
        }
    }).use('test', 'event-tap', 'node-event-simulate', 'ez-errorview', function (Y) {
        var container = Y.one('.container'),
            testErrorCode = "404",
            testErrorText = "Not Found",
            GESTURE_MAP = Y.Event._GESTURE_MAP;

        // trick to simulate a tap event
        // taken from https://github.com/yui/yui3/blob/master/src/event/tests/unit/assets/event-tap-functional-tests.js
        Y.Node.prototype.tap = function (startOpts, endOpts) {
            Y.Event.simulate(this._node, GESTURE_MAP.start, startOpts);
            Y.Event.simulate(this._node, GESTURE_MAP.end, endOpts);
        };
        Y.NodeList.importMethod(Y.Node.prototype, 'tap');

        viewTest = new Y.Test.Case({
            name: "eZ Error View test",

            _should: {
                ignore: {
                    "Should fire the 'close' event when tapping 'close' link": (Y.UA.phantomjs), // tap trick does not work in phantomjs
                    "Should fire the 'retry' event when tapping 'retry' link": (Y.UA.phantomjs) // tap trick does not work in phantomjs
                }
            },

            setUp: function () {
                this.view = new Y.eZ.ErrorView({
                    container: container,
                    retryAction : {},
                    additionalInfo : {
                        errorCode : testErrorCode,
                        errorText : testErrorText
                    }
                });
            },

            tearDown: function () {
                this.view.destroy();
            },

            "Test render": function () {
                var templateCalled = false,
                    origTpl;

                origTpl = this.view.template;
                this.view.template = function () {
                    templateCalled = true;
                    return origTpl.apply(this, arguments);
                };
                this.view.render();
                Y.Assert.isTrue(templateCalled, "The template should have used to render the this.view");
                Y.Assert.areNotEqual("", container.getHTML(), "View container should contain the result of the this.view");
            },

            "Test available variable in template": function () {
                this.view.template = function (variables) {
                    Y.Assert.isObject(variables, "The template should receive some variables");
                    Y.Assert.areEqual(1, Y.Object.keys(variables).length, "The template should receive 1 variable");
                    Y.Assert.isObject(variables.additionalInfo, "additionalInfo should be available in the template and should be an object");

                    return "";
                };
                this.view.render();
            },

            "Should fire the 'close' event when tapping 'close' link": function () {
                var closeFired = false,
                    close;

                this.view.render();

                this.view.on('closeApp', function (e) {
                    closeFired = true;
                });

                close = Y.one('.ez-close-app');
                close.tap({
                    target: close,
                    type: GESTURE_MAP.start,
                    bubbles: true,            // boolean
                    cancelable: true,         // boolean
                    view: window,               // DOMWindow
                    detail: 0,
                    pageX: 5,
                    pageY:5,            // long
                    screenX: 5,
                    screenY: 5,  // long
                    clientX: 5,
                    clientY: 5,   // long
                    ctrlKey: false,
                    altKey: false,
                    shiftKey:false,
                    metaKey: false, // boolean
                    touches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: close
                        }
                    ],            // TouchList
                    targetTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: close
                        }
                    ],      // TouchList
                    changedTouches: []     // TouchList
                }, {
                    target: close,
                    type: GESTURE_MAP.end,
                    bubbles: true,            // boolean
                    cancelable: true,         // boolean
                    view: window,               // DOMWindow
                    detail: 0,
                    pageX: 5,
                    pageY:5,            // long
                    screenX: 5,
                    screenY: 5,  // long
                    clientX: 5,
                    clientY: 5,   // long
                    ctrlKey: false,
                    altKey: false,
                    shiftKey:false,
                    metaKey: false, // boolean
                    touches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: close
                        }
                    ],            // TouchList
                    targetTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: close
                        }
                    ],      // TouchList
                    changedTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: close
                        }
                    ]
                });
                Y.assert(closeFired, "The close event should have been fired");
            },

            "Should fire the 'retry' event when tapping 'retry' link": function () {
                var retryFired = false,
                    retry;

                this.view.render();

                this.view.on('retry', function (e) {
                    retryFired = true;
                });

                retry = Y.one('.ez-retry');
                retry.tap({
                    target: retry,
                    type: GESTURE_MAP.start,
                    bubbles: true,            // boolean
                    cancelable: true,         // boolean
                    view: window,               // DOMWindow
                    detail: 0,
                    pageX: 5,
                    pageY:5,            // long
                    screenX: 5,
                    screenY: 5,  // long
                    clientX: 5,
                    clientY: 5,   // long
                    ctrlKey: false,
                    altKey: false,
                    shiftKey:false,
                    metaKey: false, // boolean
                    touches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: retry
                        }
                    ],            // TouchList
                    targetTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: retry
                        }
                    ],      // TouchList
                    changedTouches: []     // TouchList
                }, {
                    target: retry,
                    type: GESTURE_MAP.end,
                    bubbles: true,            // boolean
                    cancelable: true,         // boolean
                    view: window,               // DOMWindow
                    detail: 0,
                    pageX: 5,
                    pageY:5,            // long
                    screenX: 5,
                    screenY: 5,  // long
                    clientX: 5,
                    clientY: 5,   // long
                    ctrlKey: false,
                    altKey: false,
                    shiftKey:false,
                    metaKey: false, // boolean
                    touches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: retry
                        }
                    ],            // TouchList
                    targetTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: retry
                        }
                    ],      // TouchList
                    changedTouches: [
                        {
                            identifier: 'foo',
                            screenX: 5,
                            screenY: 5,
                            clientX: 5,
                            clientY: 5,
                            pageX: 5,
                            pageY: 5,
                            radiusX: 15,
                            radiusY: 15,
                            rotationAngle: 0,
                            force: 0.5,
                            target: retry
                        }
                    ]
                });
                Y.assert(retryFired, "The retry event should have been fired");
            },

            "Should fire a close event when 'escape' hotkey is pressed": function () {
                var closeFired = false;

                this.view.on('closeApp', function (e) {
                    closeFired = true;
                });

                this.view.render();
                container.one('.ez-error-content').simulate("keyup", { charCode: 27 }); // Sending "escape" key code
                Y.assert(closeFired, "The close event should have been fired");
            },

            "Should NOT fire a close event when any hotkey other than 'escape' is pressed": function () {
                var closeFired = false;

                this.view.on('closeApp', function (e) {
                    closeFired = true;
                });

                this.view.render();
                container.one('.ez-error-content').simulate("keypress", { charCode: 28 }); // Sending some other key code
                Y.assert(!closeFired, "The close event should NOT have been fired");
            },

            "Should focus on the content element using special method": function () {
                var focused = false;
                this.view.render();

                container.one('.ez-error-content').on('focus', function () {
                    focused = true;
                });

                this.view.setFocus();

                Y.assert(focused, "Main content node of the view should get the focus");
            }

        });

        Y.Test.Runner.setName("eZ Error View tests");
        Y.Test.Runner.add(viewTest);
        Y.Test.Runner.run();

    });
</script>
</body>
</html>
