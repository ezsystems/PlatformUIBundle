# Use trusty for better performance (and avoiding mysql/postgres/solr gone issues on precise and container infra)
dist: trusty
sudo: required
language: php

env:
    global:
        secure: "aNPcXEtgV3Q/GVCH+FvITm/gLXcNyFl7YiOT9JcqZUwYXsT2zi8g4BcwBgDtpbSmi8NSCsEWONNxxDM10BqCPzfkiFD2I0cPHXVxmJ3cmOqySci5JvysEd+RU6gnatCxqzAJYDH2BanfPyu+yPwrSIgWdkPuvNhydNJFUrwsinw="

cache:
  directories:
    - node_modules # NPM packages
    - $HOME/.composer/cache/files

matrix:
    fast_finish: true
    include:
        # Run behat first as it takes the most time (don't need to specify php version here as we don't really care about version on host)
        - php: 7.1
          env: 
            - BEFORE="./bin/travis/prepare_behat.sh" 
            - BEHAT_OPTS="-vv --no-interaction --profile=platformui --tags=~@edge"
            - AFTER_SUCCESS='echo "After success"' 
            - RUN_INSTALL=1 
            - COMPOSE_FILE="doc/docker/base-dev.yml:doc/docker/redis.yml:doc/docker/selenium.yml" 
            - SYMFONY_ENV=behat 
            - SYMFONY_DEBUG=0
        - php: 7.1
          env: 
            - BEFORE="./bin/travis/prepare_behat.sh" 
            - BEHAT_OPTS="-vv --no-interaction --profile=platformui --tags=~@edge --tags=~@EZP-29193-exclude-varnish"
            - AFTER_SUCCESS='echo "After success"' 
            - RUN_INSTALL=1 
            - WEB_HOST=varnish 
            - COMPOSE_FILE="doc/docker/base-dev.yml:doc/docker/varnish.yml:doc/docker/redis.yml:doc/docker/selenium.yml" 
            - SYMFONY_ENV=behat 
            - SYMFONY_DEBUG=0
        - env: BEFORE="./bin/travis/setupnode.sh" TEST_CMD="./bin/travis/runnode.sh" AFTER_SUCCESS="./bin/travis/generate_apidoc.sh" COMPOSER_MEMORY_LIMIT=4g
        - php: 7.0
          env: BEFORE="./bin/travis/setupphpunit.sh" SYMFONY_VERSION="^2.8" TEST_CMD="./vendor/bin/phpunit -c phpunit.xml" AFTER_SUCCESS='echo "After success"' COMPOSER_MEMORY_LIMIT=4g
        - php: 7.1
          env: BEFORE="./bin/travis/setupphpunit.sh" SYMFONY_VERSION="^3.2" TEST_CMD="./vendor/bin/phpunit -c phpunit.xml" AFTER_SUCCESS='echo "After success"' COMPOSER_MEMORY_LIMIT=4g
        - php: 5.6
          env: BEFORE='./bin/travis/setupphpunit.sh' TEST_CMD="./vendor/bin/phpunit -c phpunit.xml" AFTER_SUCCESS='echo "After success"' COMPOSER_MEMORY_LIMIT=4g

# test only master (+ Pull requests)
branches:
    only:
        - master
        - /^\d.\d+$/

before_install:
    - phpenv config-rm xdebug.ini
    - echo 'memory_limit = -1' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

before_script:
    - $BEFORE
    - if [ "$BEHAT_OPTS" != "" ] ; then cd "$HOME/build/ezplatform"; docker-compose exec --user root app sh -c "chown -R www-data:www-data ." ; fi
    - if [ "$BEHAT_OPTS" != "" ] ; then cd "$HOME/build/ezplatform"; docker-compose exec --user www-data app sh -c "composer config repositories.test vcs http://github.com/konradoboza/ezpublish-kernel" ; fi
    - if [ "$BEHAT_OPTS" != "" ] ; then docker-compose exec --user www-data app sh -c 'composer require ezsystems/ezpublish-kernel:"dev-EZP-29234-custom_vendor_prefix as 6.13.x-dev"' ; fi
    - if [ "$BEHAT_OPTS" == "" ] ; then composer config repositories.test vcs http://github.com/konradoboza/ezpublish-kernel ; fi
    - if [ "$BEHAT_OPTS" == "" ] ; then composer require ezsystems/ezpublish-kernel:"dev-EZP-29234-custom_vendor_prefix as 6.13.x-dev"; fi

script: 
- if [ "${BEHAT_OPTS}" != "" ]; then cd "$HOME/build/ezplatform"; docker-compose exec --user www-data app sh -c "./bin/behat $BEHAT_OPTS" ; fi
- if [ "${TEST_CMD}" != "" ]; then $TEST_CMD ; fi

after_success:
    - if [ $TRAVIS_PULL_REQUEST = "false" ] ; then $AFTER_SUCCESS ; fi
