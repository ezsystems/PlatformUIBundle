YUI.add('ez-emailaddress-editview', function (Y) {
    "use strict";
    /**
     * Provides the field edit view for the Email Address (ezemail) fields
     *
     * @module ez-emailaddress-editview
     */

    Y.namespace('eZ');

    var FIELDTYPE_IDENTIFIER = 'ezemail';

    /**
     * Email Address edit view
     *
     * @namespace eZ
     * @class EmailAddressEditView
     * @constructor
     * @extends eZ.FieldEditView
     */
    Y.eZ.EmailAddressEditView = Y.Base.create('emailAddressEditView', Y.eZ.FieldEditView, [], {
        events: {
            '.ez-emailaddress-input-ui input': {
                'blur': 'validate',
                'valuechange': '_validateIfNotValid'
            }
        },

        /**
         * Validates the current input of email address
         *
         * @method validate
         */
        validate: function () {
            var validity = this._getInputValidity();

            if ( validity.typeMismatch ) {
                this.set('errorStatus', 'The value should be an email address');
            } else if ( validity.valueMissing ) {
                this.set('errorStatus', 'This field is required');
            } else {
                this.set('errorStatus', false);
            }
        },

        /**
         * Validates the input only if it is not valid already.
         * This approach allows not to nag the user with error messages while
         * he inputs value for the first time (before a blur from the input),
         * at the same time allowing real-time response once a mistake is
         * corrected.
         *
         * @method _validateIfNotValid
         */
        _validateIfNotValid: function () {
            if (this.get('errorStatus')) {
                this.validate();
            }
        },

        /**
         * Defines the variables to imported in the field edit template for
         * email address.
         *
         * @protected
         * @method _variables
         * @return {Object} containing isRequired, maxLength and minLength
         * entries
         */
        _variables: function () {
            return {
                "isRequired": this.get('fieldDefinition').isRequired
            };
        },

        /**
         * Returns the input validity state object for the input generated by
         * the email address template
         *
         * See https://developer.mozilla.org/en-US/docs/Web/API/ValidityState
         *
         * @protected
         * @method _getInputValidity
         * @return {ValidityState}
         */
        _getInputValidity: function () {
            return this.get('container').one('.ez-emailaddress-input-ui input').get('validity');
        }
    });

    Y.eZ.FieldEditView.registerFieldEditView(
        FIELDTYPE_IDENTIFIER, Y.eZ.EmailAddressEditView
    );
});
